<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dare-Roulette - Challenge Yourself</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        body {
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }

        .snap-container {
            scroll-snap-type: y mandatory;
            -webkit-overflow-scrolling: touch;
        }

        .snap-item {
            scroll-snap-align: start;
        }

        @keyframes spin-wheel {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(1440deg);
            }
        }

        .spin-animation {
            animation: spin-wheel 3s cubic-bezier(0.17, 0.67, 0.12, 0.99);
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .wheel {
            width: 320px;
            height: 320px;
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 40px rgba(168, 85, 247, 0.5);
            overflow: hidden;
        }

        .wheel-text {
            position: absolute;
            width: 100%;
            height: 50%;
            left: 50%;
            transform-origin: bottom;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 20px;
            font-size: 24px;
        }

        ::-webkit-scrollbar {
            display: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounce-slow {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }

        .animate-slideUp {
            animation: slideUp 0.4s ease-out;
        }

        .animate-bounce-slow {
            animation: bounce-slow 3s ease-in-out infinite;
        }
    </style>
</head>

<body class="bg-black text-white overflow-hidden h-screen"> <!-- Mobile Search Bar -->
    <div class="fixed top-0 left-0 right-0 bg-gradient-to-b from-black via-black/95 to-transparent z-40 lg:hidden">
        <div class="px-4 py-3 backdrop-blur-xl border-b border-white/10">
            <div class="relative"> <input type="text" id="userSearchMobile" placeholder="Search users..."
                    class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2 pl-10 text-sm focus:outline-none focus:border-purple-500/50 transition-all"
                    onkeyup="searchUsers(this.value)" /> <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
            </div>
            <div id="searchResultsMobile"
                class="hidden mt-2 glassmorphism rounded-xl border border-white/10 max-h-60 overflow-y-auto"></div>
        </div>
    </div> <!-- Mobile Bottom Navigation -->
    <nav
        class="fixed bottom-0 left-0 right-0 bg-gradient-to-t from-black via-black/95 to-transparent z-50 pb-safe lg:hidden">
        <div class="flex justify-around items-center px-2 py-3 backdrop-blur-xl border-t border-white/10"> <button
                onclick="showView('feed')" id="feedBtnMobile"
                class="flex flex-col items-center gap-1 px-4 py-2 rounded-2xl transition-all duration-300"> <span
                    class="text-2xl">üè†</span> <span class="text-xs font-medium">Feed</span> </button> <button
                onclick="showView('dare')" id="dareBtnMobile"
                class="flex flex-col items-center gap-1 px-4 py-2 rounded-2xl transition-all duration-300"> <span
                    class="text-2xl">üé°</span> <span class="text-xs font-medium">Spin</span> </button> <button
                onclick="showView('upload')" id="uploadBtnMobile"
                class="flex flex-col items-center gap-1 px-4 py-2 rounded-2xl transition-all duration-300"> <span
                    class="text-2xl">üì§</span> <span class="text-xs font-medium">Upload</span> </button> <button
                onclick="viewProfile()" id="profileBtnMobile"
                class="flex flex-col items-center gap-1 px-4 py-2 rounded-2xl transition-all duration-300">
                <div
                    class="w-7 h-7 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center font-bold text-sm shadow-lg">
                    {{user.avatar}} </div> <span class="text-xs font-medium">Profile</span>
            </button> </div>
    </nav> <!-- Desktop Sidebar -->
    <aside
        class="hidden lg:flex fixed left-0 top-0 h-screen w-64 bg-gradient-to-b from-purple-900/20 to-pink-900/20 border-r border-white/10 backdrop-blur-xl flex-col p-6 z-50">
        <div class="mb-8">
            <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                üéØ Dare-Roulette </h1>
        </div> <!-- Search Bar -->
        <div class="mb-6">
            <div class="relative"> <input type="text" id="userSearchDesktop" placeholder="Search users..."
                    class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2 pl-10 text-sm focus:outline-none focus:border-purple-500/50 transition-all"
                    onkeyup="searchUsers(this.value)" /> <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
            </div>
            <div id="searchResultsDesktop"
                class="hidden mt-2 glassmorphism rounded-xl border border-white/10 max-h-60 overflow-y-auto"></div>
        </div>
        <nav class="flex flex-col gap-3 flex-1"> <button onclick="showView('feed')" id="feedBtnDesktop"
                class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 transition-all duration-300">
                <span class="text-2xl">üè†</span> <span class="font-medium">Feed</span> </button> <button
                onclick="showView('dare')" id="dareBtnDesktop"
                class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 transition-all duration-300">
                <span class="text-2xl">üé°</span> <span class="font-medium">Spin Wheel</span> </button> <button
                onclick="showView('upload')" id="uploadBtnDesktop"
                class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 transition-all duration-300">
                <span class="text-2xl">üì§</span> <span class="font-medium">Upload</span> </button> </nav>
        <!-- User Profile -->
        <div class="mt-auto pt-4 border-t border-white/10"> <button onclick="toggleProfileMenu()"
                class="w-full glassmorphism rounded-xl p-3 hover:bg-white/10 transition-all duration-300 flex items-center gap-3">
                <div
                    class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center font-bold text-lg shadow-lg">
                    {{user.avatar}} </div>
                <div class="flex-1 text-left">
                    <p class="font-semibold text-sm">{{user.username}}</p>
                    <p class="text-xs text-gray-400">{{user.short_bio}}...</p>
                </div> <span class="text-gray-400">‚ãÆ</span>
            </button> <!-- Profile Dropdown Menu -->
            <div id="profileMenu" class="hidden mt-2 glassmorphism rounded-xl border border-white/10 overflow-hidden">
                <button onclick="viewProfile()"
                    class="w-full px-4 py-3 hover:bg-white/10 transition-all text-left flex items-center gap-3 text-sm">
                    <span>üë§</span> <span>View Profile</span> </button> <button onclick="viewSettings()"
                    class="w-full px-4 py-3 hover:bg-white/10 transition-all text-left flex items-center gap-3 text-sm">
                    <span>‚öôÔ∏è</span> <span>Settings</span> </button>
                <div class="border-t border-white/10"></div> <button onclick="logout()"
                    class="w-full px-4 py-3 hover:bg-red-500/20 transition-all text-left flex items-center gap-3 text-sm text-red-400">
                    <span>üö™</span> <span>Logout</span> </button>
            </div>
        </div>
<script>
    const dares = {{ dares_from_DB | tojson }};

    let currentVideo = null;
    let feed = [];
    let isLoading = false;
    let currentDare = null;
    let acceptedDare = null;
    let isSpinning = false;
    let url = null;
    let userInteracted = false;
    let watchTimers = {};
    let watchedVideos = new Set();
    let scrollObserver = null;

    const CLOUD_NAME = "dsfn0sc3w";
    const UPLOAD_PRESET = "Dare-Roulette";

    document.addEventListener(
        "click",
        () => {
            userInteracted = true;
        },
        { once: true }
    );

    const videoObserver = new IntersectionObserver(
        entries => {
            entries.forEach(entry => {
                const video = entry.target;

                if (!userInteracted) return;

                if (entry.isIntersecting) {
                    if (currentVideo && currentVideo !== video) {
                        currentVideo.pause();
                        currentVideo.currentTime = 0;
                    }

                    currentVideo = video;
                    video.muted = false;
                    video.play().catch(err => console.log("Play error:", err));
                } else {
                    if (currentVideo === video) {
                        currentVideo.pause();
                    }
                }
            });
        },
        { threshold: 0.7 }
    );

    function observeNewVideos() {
        document.querySelectorAll(".short-video").forEach(video => {
            if (!video.dataset.observed) {
                videoObserver.observe(video);
                video.dataset.observed = "true";

                video.addEventListener("click", () => {
                    userInteracted = true;
                    if (video.paused) video.play();
                    else video.pause();
                });
            }
        });
    }

    function setupScrollObserver() {
        if (scrollObserver) {
            scrollObserver.disconnect();
        }

        scrollObserver = new IntersectionObserver(
            async entries => {
                const lastEntry = entries[0];
                if (lastEntry && lastEntry.isIntersecting && !isLoading) {
                    await loadFeed();
                }
            },
            { threshold: 0.5 }
        );
    }

    function observeLastVideo() {
        const videos = document.querySelectorAll(".video-item");
        if (videos.length > 0 && scrollObserver) {
            const lastVideo = videos[videos.length - 1];
            scrollObserver.observe(lastVideo);
        }
    }

    function setupVideoTracking() {
        const shortVideos = document.querySelectorAll(".short-video");

        shortVideos.forEach(video => {
            video.addEventListener("play", () => {
                watchTimers[video.id] = Date.now();
            });

            const handleWatchEnd = () => {
                if (watchTimers[video.id] && !watchedVideos.has(video.id)) {
                    const watchedSeconds = Math.floor(
                        (Date.now() - watchTimers[video.id]) / 1000
                    );
                    if (watchedSeconds >= 3) {
                        onVideoWatched(video.id, watchedSeconds);
                        watchedVideos.add(video.id);
                    }
                }
            };

            video.addEventListener("pause", handleWatchEnd);
            video.addEventListener("ended", handleWatchEnd);
        });
    }

    async function loadFeed() {
        if (isLoading) return;
        isLoading = true;

        try {
            const response = await fetch("/api/get-videos", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    offset: feed.length,
                    limit: 5
                })
            });

            const newVideos = await response.json();

            if (Array.isArray(newVideos) && newVideos.length > 0) {
                feed = [...feed, ...newVideos];
                renderNewVideos(newVideos);

                setTimeout(() => {
                    observeLastVideo();
                    observeNewVideos();
                }, 100);
            }
        } catch (err) {
            console.error("Feed error:", err);
        } finally {
            isLoading = false;
        }
    }

    function renderNewVideos(videos) {
        const container = document.getElementById("feedContainer");

        videos.forEach(item => {
            if (!item.video || !item.user || !item.dare) return;

            const videoId = `video-${item.video.id}`;
            const clickAreaId = `click-${item.video.id}`;

            const videoHTML = `
            <div class="video-item h-screen snap-item relative flex items-center justify-center bg-gradient-to-br from-purple-950/50 via-black to-pink-950/50">
                <div id="${clickAreaId}" class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent z-10 cursor-pointer"></div>

                ${
                    item.video.video_url
                        ? `
                    <video
                        src="${item.video.video_url}"
                        class="short-video absolute inset-0 w-full h-full object-contain bg-black"
                        id="${videoId}"
                        muted
                        loop
                        playsinline
                        preload="metadata">
                    </video>
                `
                        : `
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-8xl mb-4">‚úì</div>
                            <p class="text-2xl font-bold text-white/80">Challenge Completed</p>
                        </div>
                    </div>
                `
                }

                <div class="absolute bottom-20 lg:bottom-8 left-0 right-0 px-6 z-20 pointer-events-none">
                    <div class="flex items-end gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3 pointer-events-auto">
                                <button class="hover:scale-105 transition-transform">
                                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center font-bold text-lg shadow-lg">
                                        ${item.user.userName[0].toUpperCase()}
                                    </div>
                                </button>
                                <button onclick="viewUserProfile(${item.user.id}, '${item.user.userName}', '${item.user.bio}', ${item.user.dares}, ${item.user.likes}, ${item.user.views}, ${JSON.stringify(
                    item.user.dares_l
                )})" class="text-left hover:opacity-80 transition-opacity">
                                    <p class="font-bold text-lg">${item.user.userName}</p>
                                    <p class="text-sm text-gray-300">${getTimeAgo(item.video.created_at)}</p>
                                </button>
                            </div>
                            <p class="text-lg font-medium mb-2">üéØ ${item.dare.text}</p>
                            <div class="flex items-center gap-4 text-sm text-gray-300">
                                <span>üëÅÔ∏è ${formatNumber(item.video.views)} views</span>
                            </div>
                        </div>

                        <div class="flex flex-col items-center gap-6 pb-2 pointer-events-auto">
                            <button onclick="likePost(${item.video.id})" class="flex flex-col items-center gap-1 transform active:scale-110 transition-transform">
                                <span id="likebtn-${item.video.id}" class="text-3xl">
                                    ${item.video.liked ? "‚ù§Ô∏è" : "ü©∂"}
                                </span>
                                <span class="text-sm font-bold" id="likes-${item.video.id}">${formatNumber(
                    item.video.likes
                )}</span>
                            </button>
                            <button class="flex flex-col items-center gap-1 transform active:scale-110 transition-transform">
                                <span class="text-3xl">üîÑ</span>
                                <span class="text-sm font-bold">Share</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

            container.insertAdjacentHTML("beforeend", videoHTML);
        });

        videos.forEach(item => {
            const video = document.getElementById(`video-${item.video.id}`);
            const clickArea = document.getElementById(`click-${item.video.id}`);

            if (video && clickArea) {
                videoObserver.observe(video);

                clickArea.onclick = () => {
                    userInteracted = true;
                    if (video.paused) {
                        video.muted = false;
                        video.play();
                    } else {
                        video.pause();
                    }
                };
            }
        });

        setupVideoTracking();
    }

    function likePost(videoId) {
        fetch("/api/like", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ post_id: videoId })
        })
            .then(res => res.json())
            .then(data => {
                if (data.error) return;

                document.getElementById(
                    `likebtn-${videoId}`
                ).textContent = data.liked ? "‚ù§Ô∏è" : "ü©∂";

                document.getElementById(
                    `likes-${videoId}`
                ).textContent = formatNumber(data.likes);
            })
            .catch(console.error);
    }

    function onVideoWatched(videoId, seconds) {
        fetch("/api/video-watched", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                video_id: videoId,
                watch_time: seconds
            })
        });
    }

    function showView(viewId) {
        const views = ["feedView", "dareView", "uploadView"];
        views.forEach(v => {
            const el = document.getElementById(v);
            if (el) el.classList.add("hidden");
        });

        const active = document.getElementById(`${viewId}View`);
        if (active) active.classList.remove("hidden");

        if (viewId !== "feed" && currentVideo) {
            currentVideo.pause();
        }

        updateNavUI(viewId);
    }

    function updateNavUI(activeView) {
        const buttons = ["feed", "dare", "upload"];
        buttons.forEach(b => {
            const mobileBtn = document.getElementById(`${b}BtnMobile`);
            const desktopBtn = document.getElementById(`${b}BtnDesktop`);
            const isActive = b === activeView;

            if (mobileBtn) {
                mobileBtn.classList.toggle("bg-purple-500/20", isActive);
                mobileBtn.classList.toggle("text-purple-400", isActive);
            }
            if (desktopBtn) {
                desktopBtn.classList.toggle("bg-white/10", isActive);
                desktopBtn.classList.toggle("text-purple-400", isActive);
            }
        });
    }

    function spinWheel() {
        if (isSpinning) return;

        isSpinning = true;
        const wheel = document.getElementById("wheel");
        const dareText = document.getElementById("dareText");
        const spinBtn = document.getElementById("spinBtn");
        const acceptBtn = document.getElementById("acceptBtn");

        wheel.classList.remove("spin-animation");
        void wheel.offsetWidth;
        wheel.classList.add("spin-animation");

        dareText.innerText = "Selecting a dare...";
        spinBtn.disabled = true;

        setTimeout(() => {
            const randomIndex = Math.floor(Math.random() * dares.length);
            currentDare = dares[randomIndex];
            dareText.innerText = currentDare;

            isSpinning = false;
            spinBtn.innerText = "üé° SPIN AGAIN";
            spinBtn.disabled = false;
            acceptBtn.classList.remove("hidden");
        }, 3000);
    }

    function acceptDare() {
        acceptedDare = currentDare;
        document.getElementById("uploadDareText").innerText = acceptedDare;
        showView("upload");

        const toast = document.createElement("div");
        toast.className =
            "fixed top-20 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-full z-[200] animate-bounce";
        toast.innerText = `Dare Accepted! ${acceptedDare}`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function handleVideoSelect(event) {
        const file = event.target.files[0];
        if (file && file.type.startsWith("video/")) {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", UPLOAD_PRESET);

            fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/video/upload`, {
                method: "POST",
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    url = data.secure_url;
                    const preview = document.getElementById("videoPreview");
                    const placeholder =
                        document.getElementById("uploadPlaceholder");
                    const previewContainer =
                        document.getElementById("videoPreviewContainer");
                    const uploadBtn = document.getElementById("uploadBtn");

                    preview.src = url;
                    placeholder.classList.add("hidden");
                    previewContainer.classList.remove("hidden");
                    uploadBtn.disabled = false;
                });
        }
    }

    async function uploadDare() {
        if (!acceptedDare) {
            alert("Accept a dare first! üéØ");
            return;
        }

        if (!url) {
            alert("Please select a video first! üìπ");
            return;
        }

        try {
            const response = await fetch("/api/upload-video", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    url: url,
                    dare_text: acceptedDare
                })
            });

            await response.json();

            document.getElementById("videoInput").value = "";
            document
                .getElementById("uploadPlaceholder")
                .classList.remove("hidden");
            document
                .getElementById("videoPreviewContainer")
                .classList.add("hidden");
            document.getElementById("uploadBtn").disabled = true;
            document.getElementById("dareText").textContent =
                "Spin the wheel to get your dare!";
            document.getElementById("acceptBtn").classList.add("hidden");
            document.getElementById("spinBtn").textContent =
                "üé° SPIN THE WHEEL";

            url = null;
            acceptedDare = null;

            showView("feed");
        } catch (err) {
            console.error("Upload error:", err);
            alert("Failed to upload video. Please try again.");
        }
    }

    function toggleProfileMenu() {
        const menu = document.getElementById("profileMenu");
        if (menu) {
            menu.classList.toggle("hidden");
        }
    }

    function viewProfile() {
        const myUsername = "{{ user.username }}";
        const bio = "{{ user.bio }}";
        const views = "{{ user.views }}";
        const likes = "{{ user.likes }}";
        const daresNum = "{{ user.dares }}";
        const daresL = {{ user.dares_l | tojson }};
        const userId = {{ user.id }};

        viewUserProfile(userId, myUsername, bio, daresNum, likes, views, daresL);
        document.getElementById("profileModalTitle").innerText = "My Profile";

        const menu = document.getElementById("profileMenu");
        if (menu && !menu.classList.contains("hidden")) {
            toggleProfileMenu();
        }
    }

    function viewUserProfile(
        userId,
        username,
        bio,
        dares = 0,
        likes = 0,
        views = 0,
        daresL
    ) {
        document.getElementById("profileModalTitle").innerText = "User Info";
        document.getElementById("modalProfileName").innerText = username;
        document.getElementById("modalProfileUsername").innerText = bio;

        const avatar = document.getElementById("modalProfileAvatar");
        avatar.innerText = username[0].toUpperCase();

        document.getElementById("modalProfileDares").innerText = dares;
        document.getElementById("modalProfileLikes").innerText = likes;
        document.getElementById("modalProfileViews").innerText = views;
        document.getElementById(
            "modalDaresTitle"
        ).innerText = `@${username}'s Challenges`;

        const list = document.getElementById("modalProfileDaresList");
        list.innerHTML = "";

        const dareData = (daresL || []).find(u => u.user_id === userId);
        if (dareData && dareData.user_data) {
            dareData.user_data.forEach(dare => {
                list.innerHTML += `
                <div class="relative group overflow-hidden rounded-2xl bg-gradient-to-br from-purple-500/20 to-pink-500/20 border border-white/10 aspect-video flex items-center justify-center hover:scale-105 transition-transform cursor-pointer">
                    <video src="${dare.vid.video_url}" class="w-full h-full object-cover"></video>
                    <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-all flex items-end p-3">
                        <div class="w-full">
                            <p class="text-sm font-semibold text-white line-clamp-2">${dare.dare.text}</p>
                            <p class="text-xs text-gray-300">${getTimeAgo(dare.vid.created_at)}</p>
                        </div>
                    </div>
                </div>
            `;
            });
        }

        const resultsMobile = document.getElementById("searchResultsMobile");
        const resultsDesktop = document.getElementById("searchResultsDesktop");
        [resultsMobile, resultsDesktop].forEach(r => {
            if (r) r.classList.add("hidden");
        });

        const searchMobile = document.getElementById("userSearchMobile");
        const searchDesktop = document.getElementById("userSearchDesktop");
        if (searchMobile) searchMobile.value = "";
        if (searchDesktop) searchDesktop.value = "";

        const modal = document.getElementById("profileModal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
    }

    function closeProfileModal() {
        const modal = document.getElementById("profileModal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
    }

    function searchUsers(query) {
        const resultsMobile = document.getElementById("searchResultsMobile");
        const resultsDesktop = document.getElementById("searchResultsDesktop");

        if (query.length < 2) {
            [resultsMobile, resultsDesktop].forEach(res => {
                if (res) res.classList.add("hidden");
            });
            return;
        }

        const mockUsers = {{ users | tojson }};
        const filtered = mockUsers.filter(u =>
            u.username.toLowerCase().includes(query.toLowerCase())
        );

        const html = filtered
            .map(
                u => `
        <div onclick='viewUserProfile(
            ${u.id},
            "${u.username}",
            "${u.bio}",
            "${u.dares}",
            "${u.likes}",
            "${u.views}",
            ${JSON.stringify(u.dares_l)}
        )' class="p-4 hover:bg-white/10 cursor-pointer">
            <div class="font-bold">@${u.username}</div>
            <div class="text-xs text-gray-400">${u.bio}</div>
        </div>
    `
            )
            .join("");

        [resultsMobile, resultsDesktop].forEach(res => {
            if (!res) return;
            res.innerHTML =
                html || '<p class="p-4 text-gray-500">No users found</p>';
            res.classList.remove("hidden");
        });
    }

    function viewSettings() {
        alert("Settings feature coming soon!");
    }

    function logout() {
        fetch("/logout", { method: "POST" }).then(
            () => (window.location.href = "/login")
        );
    }

    function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + "M";
        if (num >= 1000) return (num / 1000).toFixed(1) + "K";
        return num;
    }

    function getTimeAgo(date) {
        const now = new Date();
        const past = new Date(date);
        const diff = Math.floor((now - past) / 1000);

        if (diff < 5) return "Just now";
        if (diff < 60) return `${diff}s ago`;

        const minutes = Math.floor(diff / 60);
        if (minutes < 60) return `${minutes}m ago`;

        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;

        const days = Math.floor(hours / 24);
        if (days < 7) return `${days}d ago`;

        const weeks = Math.floor(days / 7);
        if (weeks < 4) return `${weeks}w ago`;

        const months = Math.floor(days / 30);
        if (months < 12) return `${months}mo ago`;

        const years = Math.floor(days / 365);
        return `${years}y ago`;
    }

    window.onload = () => {
        setupScrollObserver();
        loadFeed();
        showView("feed");

        document.addEventListener(
            "click",
            () => {
                userInteracted = true;
            },
            { once: true }
        );
    };
</script>
</aside>
</body>
</html>
